<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="user-scalable=no">
	<title>Discover My Image</title>
    <link rel="stylesheet" href="css/common.css">
	<script src="game.min.js"></script>
	<script>
		let originalImage;
		function winAction() {
			const stage = document.getElementById('stage');
			stage.innerHTML = '';
			stage.style.backgroundImage=`URL(${originalImage.src})`;
		}
		function upload() {
			if(originalImage) {
				window.$disc.xhrHandler.uploadImage(window.$disc.xhrHandler.createBean(originalImage.src, 'roger@crazything.de'));
			}
		}

		function processFile(promise) {
			const ih = window.$disc.imageHandler;
			promise.then(image => {
				originalImage = image;
				ih.modifyImage(image, [ih.convert2BW, ih.simpleDarken])
						.then(bgImg => {
							const stage = document.getElementById('stage');
							stage.style.backgroundImage = `URL(${bgImg.src})`;
							stage.style.height = `${bgImg.height}px`;
							stage.style.width = `${bgImg.width}px`;
						});
				return image;
			}).then(image => {
				const tiles = window.$disc.tileManager.buildTiles(image, 4, 4, winAction);
				const stage = document.getElementById('stage');
				stage.innerHTML = '';
				tiles.forEach(tile => {
					stage.appendChild(tile.toNode());
				})
			}).catch(err => alert(err));
		}
		window.addEventListener('load', () => {

			const uuidCapture = location.href.match(/uuid=(.*?)(&|$)/i);
			const uuid = uuidCapture ? uuidCapture[1] : null;
			if(uuid) {
				processFile(window.$disc.xhrHandler.getImage(uuid).then(bean => {
					return new Promise(resolve => {
						const img = new Image();
						img.src = bean.imgSrc;
						img.onload = () => {
							resolve(img);
						};
					})
				}));
			}

			function handleFileSelect(evt) {
				window.$disc.menuHandler.handleMenuClick([], ['selectModal', 'modalLayer']);
				processFile(window.$disc.imageHandler.getFile(evt));
			}

			function handleDragOver(evt) {
				evt.stopPropagation();
				evt.preventDefault();
				evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
			}

			const dropZone = document.getElementById('drop_zone');
			dropZone.addEventListener('dragover', handleDragOver, false);
			dropZone.addEventListener('drop', handleFileSelect, false);

			document.getElementById('files').addEventListener('change', handleFileSelect, false);
		}, false);

		const $mH = window.$disc.menuHandler;
	</script>

</head>
<body>
	<dynStylecontainer></dynStylecontainer>
<!--	<div onclick="upload()">UPLOAD</div>-->
	<div class="modalLayer" id="modalLayer">
		<div class="menuModal"></div>
		<div class="selectModal" id="selectModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick([], ['selectModal','modalLayer']);">
					<div></div>
				</div>
			</div>
			<div style="clear: both"></div>
			<div id="drop_zone" class="selectOption">Drop an image file here</div>
			<label class="custom-file-upload selectOption">
				<input type="file" id="files"/>
				Or click here to select a file
			</label>
		</div>
	</div>

	<div class="header">
		<div class="nav-icon" style="float:left;" onclick="$mH.handleMenuClick(['selectModal','modalLayer'], []);">
			<div></div>
		</div>
		<div style="text-align:right;font-size:32px;color:white;padding:2px 22px;"><img alt="logo" src="img/assets/logo.png" height="70" /></div>
	</div>





	<div id="stage"></div>
</body>
</html>
