window.$disc=window.$disc||{},function(t){Element.prototype.addClass=Element.prototype.addClass||function(t){const e=this.getAttribute("class");return this.setAttribute("class",e?e+" "+t:t),this},Element.prototype.removeClass=Element.prototype.removeClass||function(t){return this.hasClass(t)?(this.setAttribute("class",this.getAttribute("class").split(" ").filter(e=>e!==t).join(" ")),this):this},Element.prototype.hasClass=Element.prototype.hasClass||function(t){return this.getAttribute("class")&&this.getAttribute("class").split(" ").find(e=>e===t)===t},t.IMAGE_STORE_URL="../discCgi/store.php",t.IMAGE_GET_URL="../discCgi/get.php",t.EXAMPLE_LIST_URL="./data/examples.json",t.LANGUAGE_URL="./data/language.json",t.EXAMPLES_FOLDER_URL="./img/examples/",t.MAX_IMAGE_WIDTH=1e3,t.MAX_IMAGE_HEIGHT=800,t.DOUBLE_CLICK_TIMEOUT=500,t.AUTO_PLAY_TIMEOUT=250,t.ANI_STEPS_TRANSLATECARD=5,t.ANI_STEPS_APPENDCARD=3,t.ANI_APPENDCARD_RESOLVE_AFTER=1,t.MILLIS_PER_STEP=25}(window.$disc.constants=window.$disc.constants||{}),window.$disc=window.$disc||{},function(t){function e(t,e){const n=document.createElement("CANVAS");return n.setAttribute("width",t+""),n.setAttribute("height",e+""),n}t.resizeImage=(t=>{const n=window.$disc.constants.MAX_IMAGE_HEIGHT,s=window.$disc.constants.MAX_IMAGE_WIDTH;return new Promise(i=>{if(t.width<=s&&t.height<=n)return void i(t);let o=0;if(t.width>=s&&(o=t.width/s),t.height>=n){const e=t.height/n;e>o&&(o=e)}const a=function(n,s){const i=e(n,s);i.getContext("2d").drawImage(t,0,0,n,s);const o=new Image;return o.src=i.toDataURL("image/jpeg"),o}(t.width/o,t.height/o);a.onload=(()=>i(a))})}),t.increaseTransparency=((t,e)=>{const n=e||.5;for(let e=0;e<t.width*t.height*4;e+=4)t.data[e+3]=Math.round(t.data[e+3]*n)}),t.simpleDarken=((t,e)=>{const n=e||.23;for(let e=0;e<t.width*t.height*4;e+=4)t.data[e]=Math.round(t.data[e]*n),t.data[e+1]=Math.round(t.data[e+1]*n),t.data[e+2]=Math.round(t.data[e+2]*n)}),t.convert2BW=(t=>{for(let e=0;e<t.width*t.height*4;e+=4){const n=t.data[e]+t.data[e+1]+t.data[e+2],s=Math.round(n/3);t.data[e]=s,t.data[e+1]=s,t.data[e+2]=s}}),t.modifyImage=((t,n)=>{const s=t.width,i=t.height,o=e(s,i).getContext("2d");o.drawImage(t,0,0,s,i);const a=o.getImageData(0,0,s,i);n.forEach(t=>t(a));const d=e(s,i);d.getContext("2d").putImageData(a,0,0);const r=new Image;return r.src=d.toDataURL("image/jpeg"),new Promise(t=>{r.onload=(()=>t(r))})}),t.getFile=(e=>{e.stopPropagation(),e.preventDefault();const n=[...e.dataTransfer?e.dataTransfer.files:e.target.files].filter(t=>t.type.match("image.*"))[0];return new Promise((e,s)=>{if(n){const s=new FileReader;s.addEventListener("load",n=>{const s=new Image;s.src=n.target.result+"",s.onload=(()=>{t.resizeImage(s).then(t=>{e(t)}).catch(t=>console.log(t))})},!0),s.readAsDataURL(n)}else s("No image")})})}(window.$disc.imageHandler=window.$disc.imageHandler||{}),window.$disc=window.$disc||{},function(t){let e,n,s,i,o,a,d=[],r=!1;function c(t,i,o,c){let l,u=!1;const g=this;function w(){if(r)return;const t=function(t){const e=d.indexOf(d.find(t=>-1!==t.indexOf(null))),n=d[e].indexOf(null),s=t.getCoords();if(s[0]===n&&1===Math.abs(s[1]-e)||s[1]===e&&1===Math.abs(s[0]-n))return{tile:d[e][n],xPos:n,yPos:e};return null}(g);var i,u;null!==t&&(r=!0,u=t,d[(i={tile:g,xPos:o,yPos:c}).yPos][i.xPos]=u.tile,d[u.yPos][u.xPos]=i.tile,o=t.xPos,c=t.yPos,window.$disc.animator.translateCard(l,o*e,c*n).then(t=>{r=!1,s.find(t=>!t.isCorrectPlaced())||a()}))}this.toNode=(()=>((l=document.createElement("DIV")).setAttribute("style",`\n                left: ${o*e}px;\n                top: ${c*n}px;\n                background-position: -${t*e}px -${i*n}px;\n            `),l.setAttribute("class","tile"),u&&(l.style.display="none"),l.onclick=w,l)),this.setOmitted=(()=>{u=!0}),this.isOmitted=(()=>u),this.isCorrectPlaced=(()=>u||t===o&&i===c),this.getCoords=(()=>[o,c]),this.getDimensions=(()=>[e,n])}t.buildTiles=((t,r,l,u)=>{a=u,i=r,o=l,function(){d=[];for(let t=0;t<o;t++){d.push([]);for(let e=0;e<i;e++)d[t].push(null)}}();const g=i*o,w=[];function m(){const t=Math.floor(Math.random()*g);return w.includes(t)?m():t}for(let t=0;t<g;t++)w.push(m());e=Math.floor(t.width/i),n=Math.floor(t.height/o),function(t){const s=document.body.getElementsByTagName("dynStylecontainer")[0],i=document.createElement("STYLE");i.innerHTML+=`\n.tile {\n            background-image: URL(${t.src});\n            width: ${e}px;\n            height: ${n}px;\n        }`,s.innerHTML="",s.appendChild(i)}(t);const h=[];for(let t=0;t<g;t++)h.push(new c(t%i,Math.floor(t/i)%o,w[t]%i,Math.floor(w[t]/i)%o));return h[Math.floor(Math.random()*g)].setOmitted(),(s=h).forEach(t=>{if(!t.isOmitted()){const e=t.getCoords();d[e[1]][e[0]]=t}}),h})}(window.$disc.tileManager=window.$disc.tileManager||{}),window.$disc=window.$disc||{},function(t){t.translateCard=((t,e,n,s,i)=>{const o=s||$disc.constants.ANI_STEPS_TRANSLATECARD,a=i||o;let d=!1;return new Promise(s=>{const i=t.offsetLeft,r=t.offsetTop,c=(e-i)/o,l=(n-r)/o,u=[],g=[];for(let t=0;t<o;t++)u.push(i+c*t),g.push(r+l*t);let w=0;const m=t.style.zIndex;t.style.zIndex="7777";const h=window.setInterval(()=>{w<o?(t.style.left=u[w]+"px",t.style.top=g[w]+"px",w===a&&(d=!0,s()),w++):(t.style.left=e+"px",t.style.top=n+"px",window.clearInterval(h),t.style.zIndex=m,d||s())},$disc.constants.MILLIS_PER_STEP)})})}(window.$disc.animator=window.$disc.animator||{}),window.$disc=window.$disc||{},function(t){t.createBean=((t,e,n,s)=>new function(t,e,n,s,i){this.imgSrc=t,this.email=s,this.myName=e,this.herName=n,this.lang=i}(t,e,n,s,$disc.lang.getCurrLang())),t.uploadImage=(t=>{const e=$disc.constants.IMAGE_STORE_URL,n=new XMLHttpRequest;n.open("POST",e,!0),n.setRequestHeader("Content-Type","application/json"),n.onload=function(t){200===this.status&&console.log(this.responseText)},n.send(JSON.stringify(t))}),t.getImage=(t=>{const e=$disc.constants.IMAGE_GET_URL;return new Promise((n,s)=>{const i=new XMLHttpRequest;i.open("GET",`${e}?uuid=${t}`,!0),i.onload=function(t){200===this.status?n(JSON.parse(this.responseText)):s(this.status)},i.send()})}),t.simpleLoadImage=(t=>new Promise((e,n)=>{const s=new Image;s.src=t,s.onload=(()=>{$disc.imageHandler.resizeImage(s).then(t=>{e(t)}).catch(t=>console.log(t))})})),t.loadJsonProperties=(t=>new Promise((e,n)=>{const s=new XMLHttpRequest;s.open("GET",t,!0),s.onload=function(t){200===this.status?e(JSON.parse(this.responseText)):n(this.status)},s.send()}))}(window.$disc.xhrHandler=window.$disc.xhrHandler||{}),window.$disc=window.$disc||{},function(t){let e=null,n="latin";const s=["en","de"];function i(t,e){t.forEach(t=>{const n=document.getElementById(t.id);n&&(n.getAttribute("placeholder")?n.setAttribute("placeholder",t.lang[e]):n.innerHTML=t.lang[e])})}t.getCurrLang=(()=>s.includes(n)?n:s[0]),t.switchLanguage=(t=>{(t=s.includes(t)?t:s[0])!==n&&(n=t,e?i(e,t):$disc.xhrHandler.loadJsonProperties($disc.constants.LANGUAGE_URL).then(n=>{e=n,i(n,t)}))}),t.getTranslation=(t=>{const i=e?n:s[0];return new Promise((n,s)=>{function o(){const o=e.find(e=>e.id===t);o?n(o.lang[i]):s("No translation found")}e?o():$disc.xhrHandler.loadJsonProperties($disc.constants.LANGUAGE_URL).then(t=>{e=t,o()})})})}(window.$disc.lang=window.$disc.lang||{}),window.$disc=window.$disc||{},function(t){let e;const n={myName:/^[A-Za-zÀ-ž\u0370-\u03FF\u0400-\u04FF]{2,32}$/,hisName:/^[A-Za-zÀ-ž\u0370-\u03FF\u0400-\u04FF]{2,32}$/,mailTo:/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,4})+$/};function s(e,n){document.getElementById("commonMessage").innerHTML=e,t.handleMenuClick(["alertModalLayer","commonAlertModal"],[]),n&&setTimeout(()=>{t.handleMenuClick([],["alertModalLayer","commonAlertModal"])},n)}t.checkImageLoaded=(()=>!!$disc.stageActions.getCurrentImage()||($disc.lang.getTranslation("noImageLoaded").then(t=>new s(t,4e3)).catch(t=>new s("No translation found")),!1)),t.alert=(t=>new s(t)),t.handleMenuClick=((t,e)=>{e.forEach(t=>document.getElementById(t).style.display="none"),t.forEach(t=>document.getElementById(t).style.display="block")}),t.upload=(t=>{const e=document.getElementById(t.myName),s=document.getElementById(t.hisName),i=document.getElementById(t.mailTo);if(!function(t,e,s){t.removeClass("wrongInput"),e.removeClass("wrongInput"),s.removeClass("wrongInput");let i=!0;return n.myName.test(t.value)||(t.addClass("wrongInput"),i=!1),n.hisName.test(e.value)||(e.addClass("wrongInput"),i=!1),n.mailTo.test(s.value)||(s.addClass("wrongInput"),i=!1),i}(e,s,i))return;const o=$disc.stageActions.getCurrentImage();o&&window.$disc.xhrHandler.uploadImage(window.$disc.xhrHandler.createBean(o.src,e.value,s.value,i.value))}),t.listExampleImages=((t,n)=>{const s=$disc.lang.getCurrLang(),i=document.getElementById(t);i.getElementsByTagName("BUTTON");e?e.forEach(t=>{document.getElementById(`exampleImageButton${t.index}`).innerHTML=t.description[s]}):$disc.xhrHandler.loadJsonProperties($disc.constants.EXAMPLE_LIST_URL).then(t=>{e=t,t.sort((t,e)=>t.index-e.index).forEach(t=>{const e=document.createElement("BUTTON");e.setAttribute("id",`exampleImageButton${t.index}`),e.innerHTML=t.description[s],e.onclick=(()=>{$disc.stageActions.processFile($disc.xhrHandler.simpleLoadImage($disc.constants.EXAMPLES_FOLDER_URL+t.filename),$disc.settingsHandler.getTileSettings()),n()}),i.appendChild(e)})})})}(window.$disc.menuHandler=window.$disc.menuHandler||{}),window.$disc=window.$disc||{},function(t){let e=[4,4];t.getSettings=(()=>e),t.getTileSettings=(()=>e),t.setSettings=(t=>{e=t})}(window.$disc.settingsHandler=window.$disc.settingsHandler||{}),window.$disc=window.$disc||{},function(t){localStorage}(window.$disc.storage=window.$disc.storage||{}),window.$disc=window.$disc||{},function(t){let e,n;function s(){e.innerHTML="",e.style.backgroundImage=`URL(${n.src})`}t.processFile=((s,i)=>{const o=window.$disc.imageHandler;s.then(t=>(n=t,o.modifyImage(t,[o.convert2BW,o.simpleDarken]).then(t=>{e.style.backgroundImage=`URL(${t.src})`}),t)).then(e=>{t.buildTiles(i)}).catch(()=>{$disc.lang.getTranslation("wrongImageFormat").then(t=>{$disc.menuHandler.alert(t)}).catch(t=>$disc.menuHandler.alert(`No translation for "${t}"`))})}),t.buildTiles=(t=>{if(n){const i=window.$disc.tileManager.buildTiles(n,t[0],t[1],s);e.innerHTML="";const o=i[0].getDimensions();e.style.height=`${o[1]*t[1]}px`,e.style.width=`${o[0]*t[0]}px`,i.forEach(t=>{e.appendChild(t.toNode())})}}),t.getCurrentImage=(()=>n),t.init=(t=>{e=t})}(window.$disc.stageActions=window.$disc.stageActions||{});