<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Discover My Image</title>
    <link rel="stylesheet" href="css/common.css">
	<script src="js/constants.js"></script>
	<script src="js/storage.js"></script>
	<script src="js/tileManager.js"></script>
	<script src="js/imageHandler.js"></script>
	<script src="js/animator.js"></script>
	<script src="js/xhrHandler.js"></script>
	<script src="js/menuHandler.js"></script>
	<script src="js/stageActions.js"></script>
	<script src="js/language.js"></script>
	<script src="js/settingsHandler.js"></script>
	<script src="js/deviceDetection.js"></script>
	<script>

		function resizeListener() {
			setTimeout(() => {
				if($disc.deviceDetection.estimate()) {
					// if we know the device
					window.removeEventListener('resize', resizeListener);
				}
			}, 88);
		}

		window.addEventListener('load', () => {
			window.addEventListener('resize', resizeListener, false);
			resizeListener(); // might be a first match
			const uuidCapture = location.href.match(/uuid=(.*?)(&|$)/i);
			const uuid = uuidCapture ? uuidCapture[1] : null;
			const langCapture = location.href.match(/lang=(.*?)(&|$)/i);

			const myLanguage = $disc.storage.getLanguage();
			const lang = myLanguage ? myLanguage : langCapture ? langCapture[1] : 'en';

			$disc.stageActions.init(document.getElementById('stage'), document.getElementById('outerStage'));

			if(uuid) {
				$disc.stageActions.processFile(window.$disc.xhrHandler.getImage(uuid).then(bean => {
					return new Promise(resolve => {
						const img = new Image();
						img.src = bean.imgSrc;
						$disc.storage.setLastLoadedImage(bean.imgSrc);
						img.onload = () => {
							resolve(img);
						};
					})
				}), $disc.settingsHandler.getTileSettings());
			} else {
				const lastLoadedImage = $disc.storage.getLastLoadedImage();
				if(lastLoadedImage) {
					$disc.stageActions.processFile(new Promise(resolve => {
						const img = new Image();
						img.src = lastLoadedImage;
						img.onload = () => {
							resolve(img);
						};
					}), $disc.settingsHandler.getTileSettings());
				}
			}

			function handleFileSelect(evt) {
				window.$disc.menuHandler.handleMenuClick([], ['selectModal', 'modalLayer']);
				$disc.stageActions.processFile(window.$disc.imageHandler.getFile(evt), $disc.settingsHandler.getTileSettings());
			}

			function handleDragOver(evt) {
				evt.stopPropagation();
				evt.preventDefault();
				evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
			}

			const dropZone = document.getElementById('dropImageZone');
			dropZone.addEventListener('dragover', handleDragOver, false);
			dropZone.addEventListener('drop', handleFileSelect, false);

			document.getElementById('files').addEventListener('input', handleFileSelect, false); // or change
			$disc.lang.switchLanguage(lang);
		}, false);

		const $mH = window.$disc.menuHandler;

		function toggleShowButtons() {
			$mH.toggleShowButton('storeGameButton', $mH.hasCurrentImage);
			$mH.toggleShowButton('uploadMenuButton', $mH.hasCurrentImage);
			$mH.toggleShowButton('changeSettingsButton', $mH.hasCurrentImage);
			$mH.toggleShowButton('loadGameButton', $mH.hasCurrentTask);

		}

	</script>
</head>
<body>
	<dynStylecontainer></dynStylecontainer>
	<div class="modalLayer" id="modalLayer">
		<div class="innerModal" id="mainMenu">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick([], ['mainMenu','modalLayer']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<button id="switchLangButton" onclick="$mH.handleMenuClick(['languageModal'], ['mainMenu']);"></button>
			<button id="exampleImageSelect" onclick="$mH.handleMenuClick(['exampleModal'], ['mainMenu']);$mH.listExampleImages('exampleModal',() => {$mH.handleMenuClick([], ['exampleModal','modalLayer']);});"></button>
			<button id="ownImageSelect" onclick="$mH.handleMenuClick(['selectModal'], ['mainMenu']);"></button>
			<button id="uploadMenuButton" onclick="if($mH.checkImageLoaded()){$mH.handleMenuClick(['uploadModal'], ['mainMenu']);}"></button>
			<button id="storeGameButton" onclick="if($mH.saveCurrentTask()){$mH.handleMenuClick([], ['mainMenu', 'modalLayer']);}"></button>
			<button id="loadGameButton" onclick="$mH.loadCurrentTask();$mH.handleMenuClick([], ['mainMenu', 'modalLayer']);"></button>
			<button id="changeSettingsButton" onclick="$mH.handleMenuClick(['settingsModal'], ['mainMenu']);"></button>
		</div>
		<div class="innerModal" id="languageModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick(['mainMenu'], ['languageModal']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<button id="langDe" onclick="$disc.lang.switchLanguage('de');$mH.handleMenuClick(['mainMenu'], ['languageModal']);"></button>
			<button id="langEn" onclick="$disc.lang.switchLanguage('en');$mH.handleMenuClick(['mainMenu'], ['languageModal']);"></button>
		</div>
		<div class="innerModal" id="exampleModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick(['mainMenu'], ['exampleModal']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
		</div>
		<div class="innerModal" id="selectModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick(['mainMenu'], ['selectModal']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<div id="dropImageZone" class="selectOption"></div>
			<label class="custom-file-upload selectOption">
				<input type="file" id="files" accept="image/png, image/jpeg, image/gif, image/bmp"/>
				<span id="selectImgFile"></span>
			</label>
		</div>
		<div class="innerModal" id="settingsModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick(['mainMenu'], ['settingsModal']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<button id="settingThree" onclick="$mH.setSettings(3);$mH.handleMenuClick([], ['settingsModal', 'mainMenu', 'modalLayer']);">3 x 3</button>
			<button id="settingFour" onclick="$mH.setSettings(4);$mH.handleMenuClick([], ['settingsModal', 'mainMenu', 'modalLayer']);">4 x 4</button>
			<button id="settingFive" onclick="$mH.setSettings(5);$mH.handleMenuClick([], ['settingsModal', 'mainMenu', 'modalLayer']);">5 x 5</button>
		</div>
		<div class="innerModal" id="uploadModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick(['mainMenu'], ['uploadModal']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<input placeholder="Your name" id="sendMyName" maxlength="128"/>
			<input placeholder="Receiver's name" id="sendHisName" maxlength="128"/>
			<input placeholder="Receiver's email address" id="sendToEmail" maxlength="128"/>
			<div>&#160;</div>
			<button id="uploadButton" onclick="$mH.upload({myName: 'sendMyName', hisName: 'sendHisName', mailTo: 'sendToEmail'});"></button>
		</div>

	</div>
	<div class="modalLayer alertModalLayer" id="alertModalLayer">
		<div class="innerModal commonAlertModal" id="commonAlertModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick([], ['commonAlertModal', 'alertModalLayer']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<div id="commonMessage"></div>
		</div>
	</div>

	<div class="header">
		<div class="nav-icon" style="float:left;" onclick="toggleShowButtons();$mH.handleMenuClick(['mainMenu','modalLayer'], []);">
			<div></div>
		</div>
		<div style="text-align:right;padding:2px 22px;"><img alt="logo" src="img/assets/logo.png" height="70" /></div>
	</div>
	<div class="contentContainer">
		<div class="myDivRow">
			<div id="outerStage">
				<div id="stage"></div>
			</div>
			<div class="myDivCell myRight">RIGHT AD</div>
		</div>
		<div class="myDivRow">
			<div class="myDivCell myBottom">BOTTOM AD</div>
			<div class="myDivCell">GET RID OF ADS</div>
		</div>

	</div>


</body>
</html>
