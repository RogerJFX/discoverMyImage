<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="user-scalable=no">
	<title>Discover me</title>
    <link rel="stylesheet" href="css/common.css">
	<script src="js/constants.js"></script>
	<script src="js/tileManager.js"></script>
	<script src="js/imageHandler.js"></script>
	<script src="js/animator.js"></script>
	<script src="js/xhrHandler.js"></script>
	<script src="js/menuHandler.js"></script>
	<script>
		let originalImage;
		function winAction() {
			const stage = document.getElementById('stage');
			stage.innerHTML = '';
			stage.style.backgroundImage=`URL(${originalImage.src})`;
		}
		function upload() {
			window.$disc.xhrHandler.uploadImage(window.$disc.xhrHandler.createBean(originalImage.src, 'roger@crazything.de'));
		}

		function processFile(promise) {
			const ih = window.$disc.imageHandler;
			promise.then(image => {
				originalImage = image;
				console.log(image.src.length);
				ih.modifyImage(image, [ih.convert2BW, ih.simpleDarken])
						.then(bgImg => {
							const stage = document.getElementById('stage');
							stage.style.backgroundImage = `URL(${bgImg.src})`;
							stage.style.height = `${bgImg.height}px`;
							stage.style.width = `${bgImg.width}px`;
						});
				return image;
			}).then(image => {
				const tiles = window.$disc.tileManager.buildTiles(image, 4, 4, winAction);
				const stage = document.getElementById('stage');
				stage.innerHTML = '';
				tiles.forEach(tile => {
					stage.appendChild(tile.toNode());
				})
			}); //.catch(err => console.error(err));
		}
		window.addEventListener('load', () => {

			const uuidCapture = location.href.match(/uuid=(.*?)(&|$)/i);
			const uuid = uuidCapture ? uuidCapture[1] : null;
			if(uuid) {
				processFile(window.$disc.xhrHandler.getImage(uuid).then(bean => {
					return new Promise(resolve => {
						const img = new Image();
						img.src = bean.imgSrc;
						img.onload = () => {
							resolve(img);
						};
					})
				}));
			}

			function handleFileSelect(evt) {
				showFileSelect(false);
				processFile(window.$disc.imageHandler.getFile(evt));
			}

			function handleDragOver(evt) {
				evt.stopPropagation();
				evt.preventDefault();
				evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
			}

			const dropZone = document.getElementById('drop_zone');
			dropZone.addEventListener('dragover', handleDragOver, false);
			dropZone.addEventListener('drop', handleFileSelect, false);

			document.getElementById('files').addEventListener('change', handleFileSelect, false);
		}, false);
		function showFileSelect(show) {
			document.getElementById('selectModal').style.display = show ? 'block' : 'none';
			document.getElementById('modalLayer').style.display = show ? 'block' : 'none';
		}
	</script>


</head>
<body>
	<stylecontainer></stylecontainer>
	<div onclick="upload()">UPLOAD</div>
	<div class="modalLayer" id="modalLayer">
		<div class="menuModal"></div>
		<div class="selectModal" id="selectModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="showFileSelect(false);">
					<div></div>
				</div>
			</div>
			<div style="clear: both"></div>
			<div id="drop_zone" class="selectOption">Drop an image file here</div>
			<label class="custom-file-upload selectOption">
				<input type="file" id="files"/>
				Or click here to select a file
			</label>
		</div>
	</div>

	<div class="header">
		<div class="nav-icon" style="float:left;"onclick="showFileSelect(true);">
			<div></div>
		</div>
		<div style="display:block; height:60px;text-align:right;font-size:26px;color:white;padding:12px;">Discover My Image</div>
	</div>





	<div id="stage"></div>
</body>
</html>
