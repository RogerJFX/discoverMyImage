<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Discover My Image</title>
    <link rel="stylesheet" href="css/common.css">
	<script src="js/constants.js"></script>
	<script src="js/storage.js"></script>
	<script src="js/tileManager.js?12"></script>
	<script src="js/imageHandler.js?123450"></script>
	<script src="js/animator.js"></script>
	<script src="js/xhrHandler.js"></script>
	<script src="js/menuHandler.js"></script>
	<script src="js/stageActions.js?123456"></script>
	<script src="js/language.js"></script>
	<script src="js/settingsHandler.js"></script>
	<script src="js/deviceDetection.js"></script>
	<script src="js/aiManager.js?12"></script>
	<script>

		function resizeListener(noTimeout) {
			function estimate() {
				$disc.deviceDetection.estimate(() => window.removeEventListener('resize', resizeListener));
			}
			if(noTimeout) {
				estimate(); // we need it immediately
			} else {
				setTimeout(estimate, 88); // Some devices will take some time while rotating
			}
		}

		window.addEventListener('load', () => {
			window.addEventListener('resize', () => resizeListener(false), false);
			resizeListener(true); // might be a first match
			const uuidCapture = location.href.match(/uuid=(.*?)(&|$)/i);
			const uuid = uuidCapture ? uuidCapture[1] : null;
			const langCapture = location.href.match(/lang=(.*?)(&|$)/i);

			const myLanguage = $disc.storage.getLanguage();
			let userLang = navigator.language || navigator.userLanguage;
			if(userLang && userLang.indexOf('-') !== -1) {
				userLang = userLang.substring(0, userLang.indexOf('-'));
			}
			const lang = myLanguage ? myLanguage : langCapture ? langCapture[1] : $disc.lang.isLangSupported(userLang) ? userLang: 'en';

			$disc.stageActions.init(document.getElementById('stage'), document.getElementById('outerStage'));

			if(uuid) {
				$disc.stageActions.processFile(window.$disc.xhrHandler.getImage(uuid).then(bean => {
					return new Promise(resolve => {
						const img = new Image();
						img.src = bean.imgSrc;
						$disc.storage.setLastLoadedImage(bean.imgSrc);
						img.onload = () => {
							resolve(img);
						};
					})
				}).catch(_ => {
					$disc.lang.getTranslation('errorWrongOrExpiredImage').then(msg => {
						$disc.menuHandler.alert(msg, 3000);
					});

					toggleWelcomeLanguage(lang);
				}));
			} else {
				const lastLoadedImage = $disc.storage.getLastLoadedImage();
				if(lastLoadedImage) {
					$disc.stageActions.processFile(new Promise(resolve => {
						const img = new Image();
						img.onload = () => {
							resolve(img);
						};
						img.src = lastLoadedImage;
					}));
				} else {
					toggleWelcomeLanguage(lang);
				}
			}

			function handleFileSelect(evt) {
				// const event = evt || window.event;
				window.$disc.menuHandler.handleMenuClick([], ['selectModal', 'modalLayer', 'modalBG']);
				$disc.stageActions.processFile(window.$disc.imageHandler.getFile(evt));
			}

			function handleDragOver(evt) {
				evt.stopPropagation();
				evt.preventDefault();
				evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
			}

			const dropZone = document.getElementById('dropImageZone');
			dropZone.addEventListener('dragover', handleDragOver, false);
			dropZone.addEventListener('drop', handleFileSelect, false);

			document.getElementById('files').addEventListener('change', (evt) => {
				handleFileSelect(evt);
			}, true); // input or change
			$disc.lang.switchLanguage(lang);
		}, false);

		const $mH = window.$disc.menuHandler;

		function toggleShowButtons() {
			$mH.toggleShowButton('storeGameButton', $mH.hasCurrentImage);
			$mH.toggleShowButton('uploadMenuButton', $mH.hasCurrentImage);
			$mH.toggleShowButton('changeSettingsButton', $mH.hasCurrentImage);
			$mH.toggleShowButton('loadGameButton', $mH.hasCurrentTask);
			$mH.toggleShowButton('solveButton', $mH.hasCurrentImage);
			$mH.toggleShowButton('waUploadButton', $mH.isMobileDevice);
		}

		function toggleWelcomeLanguage(lang) {
			const welcomeDiv = document.getElementById('welcome');
			if(welcomeDiv) {
				const children = welcomeDiv.querySelectorAll('DIV.welcome');
				[... children].forEach(node => node.addClass('hiddenDiv'));
				const divToShow = document.getElementById(`welcome-${lang || $disc.lang.getCurrLang()}`);
				if(divToShow) {
					divToShow.removeClass('hiddenDiv');
				}
				$mH.handleMenuClick([], ['mainMenu', 'languageModal','modalLayer', 'modalBG']);
			}
		}
	</script>
<!--	<script data-ad-client="ca-pub-5386329083980702" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>-->
</head>
<body>
<div id="spinnerBG"><div class="spinner-wrapper">
	<div class="lds-grid"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
</div></div>
	<dynStylecontainer></dynStylecontainer>
	<div class="modalBG" id="modalBG"></div>

	<div class="modalLayer" id="modalLayer">
		<div class="innerModal" id="mainMenu">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick([], ['mainMenu','modalLayer', 'modalBG']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<button id="switchLangButton" onclick="$mH.handleMenuClick(['languageModal','modalLayer', 'modalBG'], ['mainMenu']);"></button>
			<button id="exampleImageSelect" onclick="$mH.handleMenuClick(['exampleModal','modalLayer', 'modalBG'], ['mainMenu']);$mH.listExampleImages('exampleModal',() => {$mH.handleMenuClick([], ['exampleModal','modalLayer','modalBG']);});"></button>
			<button id="ownImageSelect" onclick="$mH.handleMenuClick(['selectModal'], ['mainMenu']);"></button>
			<button id="uploadMenuButton" onclick="if($mH.checkImageLoaded()){$mH.handleMenuClick(['uploadModal'], ['mainMenu']);}"></button>
			<button id="storeGameButton" onclick="if($mH.saveCurrentTask()){$mH.handleMenuClick([], ['mainMenu', 'modalLayer', 'modalBG']);}"></button>
			<button id="loadGameButton" onclick="$mH.loadCurrentTask();$mH.handleMenuClick([], ['mainMenu', 'modalLayer', 'modalBG']);"></button>
			<button id="changeSettingsButton" onclick="$mH.handleMenuClick(['settingsModal'], ['mainMenu']);"></button>
			<button id="solveButton" onclick="if($mH.solveCurrentTask()){$mH.handleMenuClick([], ['mainMenu', 'modalLayer', 'modalBG']);}"></button>
			<button id="aboutButton" onclick="$mH.handleMenuClick(['aboutModal'], ['mainMenu']);"></button>
		</div>
		<div class="innerModal" id="languageModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick(['mainMenu'], ['languageModal']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<button id="langDe" onclick="$disc.lang.switchLanguage('de');$mH.handleMenuClick(['mainMenu'], ['languageModal']);toggleWelcomeLanguage()"></button>
			<button id="langEn" onclick="$disc.lang.switchLanguage('en');$mH.handleMenuClick(['mainMenu'], ['languageModal']);toggleWelcomeLanguage()"></button>
		</div>
		<div class="innerModal" id="exampleModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick([], ['exampleModal', 'modalLayer', 'modalBG']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
		</div>
		<div class="innerModal" id="selectModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick([], ['selectModal', 'modalLayer', 'modalBG']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<div id="dropImageZone" class="selectOption"></div>
			<label class="custom-file-upload selectOption">
				<input type="file" id="files" accept="image/png, image/jpeg, image/gif, image/bmp"/>
				<span id="selectImgFile"></span>
			</label>
		</div>
		<div class="innerModal" id="settingsModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick(['mainMenu'], ['settingsModal']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<button id="settingLevelKidding" onclick="$mH.setLevel(1);$mH.handleMenuClick([], ['settingsModal', 'mainMenu', 'modalLayer', 'modalBG']);">3 x 3</button>
			<button id="settingLevelEasy" onclick="$mH.setLevel(2);$mH.handleMenuClick([], ['settingsModal', 'mainMenu', 'modalLayer', 'modalBG']);">3 x 3</button>
			<button id="settingLevelMedium" onclick="$mH.setLevel(3);$mH.handleMenuClick([], ['settingsModal', 'mainMenu', 'modalLayer', 'modalBG']);">3 x 3</button>
			<button id="settingLevelHard" onclick="$mH.setLevel(4);$mH.handleMenuClick([], ['settingsModal', 'mainMenu', 'modalLayer', 'modalBG']);">3 x 3</button>
			<button id="settingLevelExtreme" onclick="$mH.setLevel(5);$mH.handleMenuClick([], ['settingsModal', 'mainMenu', 'modalLayer', 'modalBG']);">4 x 4</button>
		</div>
		<div class="innerModal" id="uploadModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick([], ['uploadModal', 'modalLayer', 'modalBG']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<input placeholder="Your name" id="sendMyName" maxlength="128"/>
			<input placeholder="Receiver's name" id="sendHisName" maxlength="128"/>
			<input placeholder="Receiver's email address" id="sendToEmail" maxlength="128"/>
			<div>&#160;</div>
			<button id="uploadButton" onclick="$mH.upload({myName: 'sendMyName', hisName: 'sendHisName', mailTo: 'sendToEmail'});"></button>
			<div>&#160;</div>
			<button id="waUploadButton" onclick="$mH.uploadUsingWhatsApp();"></button>
		</div>
		<div class="innerModal" id="aboutModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick([], ['aboutModal', 'modalLayer', 'modalBG']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<div id="txtImprint"></div>
		</div>

	</div>
	<div class="modalLayer alertModalLayer" id="alertModalLayer">
		<div class="innerModal commonAlertModal" id="commonAlertModal">
			<div style="float:right">
				<div class="nav-icon cancel-icon" onclick="$mH.handleMenuClick([], ['commonAlertModal', 'alertModalLayer']);">
					<div></div>
				</div>
			</div><div style="clear: both"></div>
			<div id="commonMessage"></div>
		</div>
	</div>

	<div class="header">
		<div class="nav-icon" style="float:left;" onclick="toggleShowButtons();$mH.handleMenuClick(['mainMenu', 'modalLayer', 'modalBG'], []);">
			<div></div>
		</div>
		<div class="logoImage"><img alt="logo" src="img/assets/logo.png" height="70" /></div>
	</div>
	<div class="contentContainer">
		<div class="myDivRow">
			<div id="outerStage">
				<div id="stage">
					<div id="welcome">
						<div id="welcome-de" class="welcome hiddenDiv">
							<h1>Hey, neu hier?</h1>
							<p>Not the expected language / Nicht die erwartete Sprache? <span class="clickMe" onclick="$mH.handleMenuClick(['languageModal','modalLayer', 'modalBG'], []);">Click here</span></p>
							<p>Discover My Image ist ein Bilder-Puzzle mit vielen Möglichkeiten.</p>
							<ul>
								<li class="clickMe" onclick="$mH.handleMenuClick(['exampleModal','modalLayer', 'modalBG'], ['mainMenu']);$mH.listExampleImages('exampleModal',() => {$mH.handleMenuClick([], ['exampleModal','modalLayer','modalBG']);});">Fange einfach mal mit einem Beispiel an</li>
								<li class="clickMe" onclick="$mH.handleMenuClick(['selectModal','modalLayer', 'modalBG'], ['mainMenu']);">Lade Dein eigenes Bild von der Festplatte</li>
								<li>Viel Spaß.</li>
							</ul>
							<p>Das Menu links oben zeigt nur jeweils verfügbare Optionen an.</p>
							<p>Ist erst einmal ein Bild geladen, gibt es weitere Optionen, wie:</p>
							<ul>
								<li>Sende Dein Puzzle einer Freundin oder einem Freund</li>
								<li>Speichere Deinen Spielstand und lade ihn später wieder</li>
								<li>Ändere die Einstellungen, schwerer oder leichter</li>
								<li>Aufgeben, aber das wirst Du sicher nicht, oder?</li>
								<li>usw.</li>
							</ul>

						</div>
						<div id="welcome-en" class="welcome hiddenDiv">
							<h1>Hey! New to Discover My Image?</h1>
							<p>Not the expected language / Nicht die erwartete Sprache? <span class="clickMe" onclick="$mH.handleMenuClick(['languageModal','modalLayer', 'modalBG'], []);">Click here</span></p>
							<p>Discover My Image is an image puzzle site with many features.</p>
							<ul>
								<li class="clickMe" onclick="$mH.handleMenuClick(['exampleModal','modalLayer', 'modalBG'], ['mainMenu']);$mH.listExampleImages('exampleModal',() => {$mH.handleMenuClick([], ['exampleModal','modalLayer','modalBG']);});">Start playing with some example image</li>
								<li class="clickMe" onclick="$mH.handleMenuClick(['selectModal','modalLayer', 'modalBG'], ['mainMenu']);">Load Your own image from hard disk</li>
								<li>Enjoy.</li>
							</ul>
							<p>The menu on top left will dynamically show only available options.</p>
							<p>Once an image is loaded, there are many more options like:</p>
							<ul>
								<li>Send Your puzzle to a friend</li>
								<li>Save current game and load it later</li>
								<li>Change settings</li>
								<li>Give up. You won't, will you?</li>
								<li>...</li>
							</ul>

						</div>
					</div>
				</div>
			</div>
			<div class="myDivCell myRight"></div>
		</div>
		<div class="myDivRow">
			<div class="myDivCell myBottom"></div>
			<div class="myDivCell"></div>
		</div>

	</div>


</body>
</html>
